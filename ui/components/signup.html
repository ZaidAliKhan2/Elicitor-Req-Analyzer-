<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signup - Elicitor</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="ElicitorLogo.png" />
    <link rel="stylesheet" href="login-signup.css" />
  </head>
  <body>
    <div class="auth-container">
      <div class="logo-section">
        <img
          src="ElicitorLogo.png"
          alt="Elicitor Logo"
          onerror="this.style.display='none'"
        />
        <h1>Elicitor</h1>
        <p>Your intelligent requirements analyzer</p>
      </div>

      <div class="auth-card">
        <h2>Create your account</h2>
        <p class="subtitle">Get started with Elicitor today</p>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <form id="signupForm">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input
              type="text"
              id="name"
              placeholder="Enter your full name"
              required
            />
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              placeholder="Enter your email"
              required
            />
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              placeholder="Create a password"
              required
            />
            <div class="password-strength">
              <div class="password-strength-bar" id="strengthBar"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input
              type="password"
              id="confirmPassword"
              placeholder="Confirm your password"
              required
            />
          </div>

          <label class="terms">
            <input type="checkbox" id="terms" required />
            <span
              >I agree to the <a href="#">Terms of Service</a> and
              <a href="#">Privacy Policy</a></span
            >
          </label>

          <button type="submit" class="btn-primary" id="signupBtn">
            Create Account
          </button>
        </form>

        <div class="divider">
          <span>OR</span>
        </div>

        <button class="guest-login" id="guestBtn">Continue as Guest</button>

        <div class="auth-footer">
          Already have an account? <a href="login.html">Sign in</a>
        </div>
      </div>
    </div>
    <script>
      const API_BASE = "http://127.0.0.1:3000";
      const signupForm = document.getElementById("signupForm");
      const signupBtn = document.getElementById("signupBtn");
      const guestBtn = document.getElementById("guestBtn");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const passwordInput = document.getElementById("password");
      const strengthBar = document.getElementById("strengthBar");

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add("show");
        successMessage.classList.remove("show");
      }

      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.classList.add("show");
        errorMessage.classList.remove("show");
      }

      // Password strength indicator (Keep this as is)
      passwordInput.addEventListener("input", () => {
        const password = passwordInput.value;
        let strength = 0;

        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        strengthBar.className = "password-strength-bar";
        if (strength >= 3) {
          strengthBar.classList.add("strong");
        } else if (strength >= 2) {
          strengthBar.classList.add("medium");
        } else if (strength >= 1) {
          strengthBar.classList.add("weak");
        }
      });

      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const terms = document.getElementById("terms").checked;

        if (!name || !email || !password || !confirmPassword) {
          showError("Please fill in all fields");
          return;
        }

        if (password !== confirmPassword) {
          showError("Passwords do not match");
          return;
        }

        if (password.length < 6) {
          // NOTE: Changed to 6, matching Mongoose schema minlength
          showError("Password must be at least 6 characters long");
          return;
        }

        if (!terms) {
          showError("Please accept the Terms of Service and Privacy Policy");
          return;
        }

        signupBtn.disabled = true;
        signupBtn.textContent = "Creating account...";
        showSuccess("Sending verification email..."); // Immediate user feedback

        try {
          const res = await fetch(API_BASE + "/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password }),
          });

          const data = await res.json();

          if (res.ok) {
            // Success response now means 'Verification email sent'
            showSuccess(
              data.message ||
                "Account created! Please check your email inbox (and spam folder) to verify your account."
            );
            // DO NOT REDIRECT YET - keep user on success message.
            signupForm.reset(); // Clear the form
          } else {
            showError(data.message || "Signup failed. Please try again.");
          }
        } catch (err) {
          showError("Connection error. Please try again.");
        } finally {
          signupBtn.disabled = false;
          signupBtn.textContent = "Create Account";
        }
      });

      guestBtn.addEventListener("click", () => {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userName");
        localStorage.removeItem("userEmail");
        window.location.href = "../app.html";
      });

      // Check if already logged in
      if (localStorage.getItem("authToken")) {
        window.location.href = "../app.html";
      }
    </script>
  </body>
</html>
